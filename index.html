import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, increment, query, deleteDoc } from 'firebase/firestore';
import { 
  Youtube, 
  Instagram, 
  Facebook, 
  Music2, 
  Heart, 
  UserPlus, 
  Zap, 
  Settings, 
  Plus, 
  Trash2,
  Play,
  X
} from 'lucide-react';

// --- Firebase Configuration & Environment Variables ---
// Using global variables provided by the environment instead of import.meta.env
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'social-booster-v2';

const App = () => {
  const [user, setUser] = useState(null);
  const [currentTab, setCurrentTab] = useState('all');
  const [videos, setVideos] = useState([]);
  const [isAdminOpen, setIsAdminOpen] = useState(false);
  const [hasInteracted, setHasInteracted] = useState(false);
  const [formData, setFormData] = useState({ platform: 'youtube', url: '', creator: '' });

  // 1. Auth & Initialization (Rule 3: Auth before queries)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Authentication failed:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. Data Fetching (Rule 1 & 2: Strict paths and simple queries)
  useEffect(() => {
    if (!user) return;

    // Correct path: /artifacts/{appId}/public/data/{collectionName}
    const videoCollection = collection(db, 'artifacts', appId, 'public', 'data', 'videos');
    const q = query(videoCollection);

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Sort in memory as per Rule 2 (No complex queries)
      const sortedData = data.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      setVideos(sortedData);
    }, (error) => {
      console.error("Firestore Error:", error);
    });

    return () => unsubscribe();
  }, [user]);

  // --- Handlers ---
  const extractId = (url, platform) => {
    try {
      if (url.includes('shorts/')) return url.split('shorts/')[1].split('?')[0];
      if (url.includes('v=')) return url.split('v=')[1].split('&')[0];
      if (url.includes('video/')) return url.split('video/')[1].split('?')[0];
      if (url.includes('reel/')) return url.split('reel/')[1].split('/')[0].split('?')[0];
      return url.split('/').pop().split('?')[0] || url;
    } catch (e) { return url; }
  };

  const handleAddVideo = async (e) => {
    e.preventDefault();
    if (!user) return;
    const vId = extractId(formData.url, formData.platform);
    
    // Strict Path adherence
    const newDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'videos'));
    
    await setDoc(newDocRef, {
      platform: formData.platform,
      creator: formData.creator,
      videoId: vId,
      originalUrl: formData.url,
      likes: 0,
      views: 0,
      follows: 0,
      createdAt: Date.now()
    });
    
    setFormData({ platform: 'youtube', url: '', creator: '' });
  };

  const handleAction = async (videoId, type) => {
    if (!user) return;
    const videoRef = doc(db, 'artifacts', appId, 'public', 'data', 'videos', videoId);
    
    try {
      await updateDoc(videoRef, {
        [type]: increment(1),
        views: increment(1)
      });

      const video = videos.find(v => v.id === videoId);
      if (type === 'follows' || type === 'likes') {
         window.open(video.originalUrl, '_blank');
      }
    } catch (err) {
      console.error("Update failed:", err);
    }
  };

  const handleDelete = async (id) => {
    if (!user) return;
    try {
      const videoRef = doc(db, 'artifacts', appId, 'public', 'data', 'videos', id);
      await deleteDoc(videoRef);
    } catch (err) {
      console.error("Delete failed:", err);
    }
  };

  const getEmbedUrl = (video) => {
    switch(video.platform) {
      case 'youtube': return `https://www.youtube.com/embed/${video.videoId}?autoplay=1&mute=1&loop=1&playlist=${video.videoId}`;
      case 'tiktok': return `https://www.tiktok.com/embed/v2/${video.videoId}`;
      case 'instagram': return `https://www.instagram.com/reel/${video.videoId}/embed/`;
      case 'facebook': return `https://www.facebook.com/plugins/video.php?href=https://www.facebook.com/reel/${video.videoId}/&show_text=0&autoplay=true`;
      default: return '';
    }
  };

  const filteredVideos = currentTab === 'all' ? videos : videos.filter(v => v.platform === currentTab);

  if (!hasInteracted) {
    return (
      <div className="fixed inset-0 bg-black flex flex-col items-center justify-center p-6 text-center z-[2000]">
        <div className="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center mb-8 animate-pulse shadow-[0_0_50px_rgba(37,99,235,0.5)]">
          <Play size={48} fill="white" color="white" />
        </div>
        <h1 className="text-4xl font-bold text-white mb-4">Community Booster</h1>
        <p className="text-gray-400 max-w-md mb-8 text-lg">
          Join the hub to help creators grow. Watch, Like, and Follow to boost their visibility across all platforms.
        </p>
        <button 
          onClick={() => setHasInteracted(true)}
          className="bg-blue-600 hover:bg-blue-500 text-white px-12 py-4 rounded-2xl font-bold text-xl transition-all hover:scale-105 active:scale-95 shadow-xl"
        >
          START BOOSTING
        </button>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#05070a] text-gray-100 pb-20">
      {/* Navigation */}
      <nav className="sticky top-0 z-50 bg-[#0f172a]/80 backdrop-blur-xl border-b border-white/10 px-6 py-4 flex justify-between items-center">
        <div className="flex items-center gap-2">
          <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center font-black shadow-lg shadow-blue-500/20">B</div>
          <h1 className="text-xl font-bold tracking-tighter hidden sm:block uppercase">Boost<span className="text-blue-500">Center</span></h1>
        </div>

        <div className="flex bg-black/40 p-1.5 rounded-2xl border border-white/5 gap-1 overflow-x-auto">
          {['all', 'youtube', 'tiktok', 'instagram', 'facebook'].map(tab => (
            <button
              key={tab}
              onClick={() => setCurrentTab(tab)}
              className={`px-4 py-2 rounded-xl text-xs font-bold transition-all uppercase whitespace-nowrap ${currentTab === tab ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-500 hover:text-white'}`}
            >
              {tab === 'all' ? 'Feed' : tab === 'youtube' ? 'YT' : tab === 'tiktok' ? 'TT' : tab === 'instagram' ? 'IG' : 'FB'}
            </button>
          ))}
        </div>

        <button onClick={() => setIsAdminOpen(true)} className="p-3 bg-white/5 rounded-2xl hover:bg-white/10 transition-colors">
          <Settings size={20} />
        </button>
      </nav>

      {/* Main Feed */}
      <main className="max-w-7xl mx-auto p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        {filteredVideos.map((video) => (
          <div key={video.id} className="group relative flex flex-col bg-[#111827] rounded-[2rem] border border-white/5 overflow-hidden transition-all hover:border-blue-500/50 hover:shadow-[0_20px_50px_rgba(0,0,0,0.5)]">
            <div className="relative aspect-[9/16] bg-black">
              <iframe 
                src={getEmbedUrl(video)}
                className="absolute inset-0 w-full h-full"
                allow="autoplay; encrypted-media"
                allowFullScreen
              />
              <div className="absolute top-4 right-4 bg-black/60 backdrop-blur-md p-2 rounded-full border border-white/10">
                {video.platform === 'youtube' && <Youtube size={16} className="text-red-500" />}
                {video.platform === 'tiktok' && <Music2 size={16} className="text-cyan-400" />}
                {video.platform === 'instagram' && <Instagram size={16} className="text-pink-500" />}
                {video.platform === 'facebook' && <Facebook size={16} className="text-blue-500" />}
              </div>
            </div>

            <div className="p-5 space-y-4">
              <div className="flex justify-between items-start">
                <div>
                  <h3 className="font-bold text-lg leading-tight truncate max-w-[150px]">{video.creator}</h3>
                  <div className="flex items-center gap-3 text-xs text-gray-500 mt-1 font-medium">
                    <span className="flex items-center gap-1"><Zap size={12} className="text-yellow-500" /> {video.views || 0}</span>
                    <span className="flex items-center gap-1"><Heart size={12} className="text-red-500" /> {video.likes || 0}</span>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-3 gap-2">
                <button 
                  onClick={() => handleAction(video.id, 'likes')}
                  className="flex flex-col items-center justify-center p-3 rounded-2xl bg-white/5 hover:bg-red-500/10 hover:text-red-400 transition-all border border-transparent hover:border-red-500/30"
                >
                  <Heart size={20} />
                  <span className="text-[10px] font-bold mt-1 uppercase">Like</span>
                </button>
                <button 
                  onClick={() => handleAction(video.id, 'follows')}
                  className="flex flex-col items-center justify-center p-3 rounded-2xl bg-white/5 hover:bg-blue-500/10 hover:text-blue-400 transition-all border border-transparent hover:border-blue-500/30"
                >
                  <UserPlus size={20} />
                  <span className="text-[10px] font-bold mt-1 uppercase">Follow</span>
                </button>
                <button 
                  onClick={() => handleAction(video.id, 'views')}
                  className="flex flex-col items-center justify-center p-3 rounded-2xl bg-white/5 hover:bg-yellow-500/10 hover:text-yellow-400 transition-all border border-transparent hover:border-yellow-500/30"
                >
                  <Zap size={20} />
                  <span className="text-[10px] font-bold mt-1 uppercase">Boost</span>
                </button>
              </div>
            </div>
          </div>
        ))}
      </main>

      {/* Admin Panel Overlay */}
      {isAdminOpen && (
        <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
          <div className="bg-[#0f172a] w-full max-w-lg rounded-[2.5rem] border border-white/10 shadow-2xl overflow-hidden">
            <div className="p-8 border-b border-white/5 flex justify-between items-center">
              <div>
                <h2 className="text-2xl font-bold">Admin Hub</h2>
                <p className="text-gray-400 text-sm">Add new videos to the global feed</p>
              </div>
              <button onClick={() => setIsAdminOpen(false)} className="p-3 bg-white/5 rounded-full hover:bg-white/10">
                <X size={20} />
              </button>
            </div>

            <form onSubmit={handleAddVideo} className="p-8 space-y-6">
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  {['youtube', 'tiktok', 'instagram', 'facebook'].map(p => (
                    <button
                      key={p}
                      type="button"
                      onClick={() => setFormData({...formData, platform: p})}
                      className={`py-3 rounded-xl text-xs font-bold uppercase border-2 transition-all ${formData.platform === p ? 'bg-blue-600 border-blue-600 text-white' : 'border-white/10 bg-white/5 text-gray-500'}`}
                    >
                      {p}
                    </button>
                  ))}
                </div>
                <input 
                  type="text" 
                  placeholder="Paste URL or ID here..." 
                  className="w-full bg-black/40 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500 transition-colors"
                  value={formData.url}
                  onChange={e => setFormData({...formData, url: e.target.value})}
                  required
                />
                <input 
                  type="text" 
                  placeholder="Creator Name (@username)" 
                  className="w-full bg-black/40 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500 transition-colors"
                  value={formData.creator}
                  onChange={e => setFormData({...formData, creator: e.target.value})}
                  required
                />
              </div>
              <button type="submit" className="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-bold text-lg shadow-xl shadow-blue-500/20 transition-all active:scale-95">
                UPLOAD & BROADCAST
              </button>
            </form>

            <div className="p-8 bg-black/20 border-t border-white/5 max-h-48 overflow-y-auto">
              <h4 className="text-xs font-bold uppercase tracking-widest text-gray-500 mb-4">Live Content ({videos.length})</h4>
              <div className="space-y-2">
                {videos.map(v => (
                  <div key={v.id} className="flex justify-between items-center bg-white/5 p-3 rounded-xl border border-white/5 text-sm">
                    <span className="truncate max-w-[200px]">{v.creator} â€¢ {v.platform}</span>
                    <button onClick={() => handleDelete(v.id)} className="text-red-500 hover:text-red-400 p-2"><Trash2 size={16} /></button>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Empty State */}
      {videos.length === 0 && (
        <div className="text-center py-40 opacity-50">
          <Zap size={48} className="mx-auto mb-4" />
          <p className="text-xl">The feed is waiting for your first boost.</p>
        </div>
      )}
    </div>
  );
};

export default App;